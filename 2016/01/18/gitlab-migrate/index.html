
 <!DOCTYPE HTML>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
    <title>docker-gitlab 数据迁移 | 结绳以渔</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="XingHua">
    

    
    <meta name="description" content="问题来源：docker 的 file system 神坑我们的 gitlab 是使用 docker 部署的，方便快捷。 但是后来服务器上的某个应用出现了内存泄露，没想到重启服务器之后整个 docker 就跪了，启动容器时总是遇到一系列比较底层的 filesystem unkown 错误，而且报错细节不止一种。调查之后，发现是 docker 使用的 devicemapper 出现了 bug，而且查看">
<meta property="og:type" content="article">
<meta property="og:title" content="docker-gitlab 数据迁移">
<meta property="og:url" content="http://starding.github.io/2016/01/18/gitlab-migrate/index.html">
<meta property="og:site_name" content="结绳以渔">
<meta property="og:description" content="问题来源：docker 的 file system 神坑我们的 gitlab 是使用 docker 部署的，方便快捷。 但是后来服务器上的某个应用出现了内存泄露，没想到重启服务器之后整个 docker 就跪了，启动容器时总是遇到一系列比较底层的 filesystem unkown 错误，而且报错细节不止一种。调查之后，发现是 docker 使用的 devicemapper 出现了 bug，而且查看">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-01-18T01:22:59.000Z">
<meta property="article:modified_time" content="2024-03-02T07:10:28.687Z">
<meta property="article:author" content="XingHua">
<meta property="article:tag" content="投资，计算机，科学哲学，技术哲学">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@starstarding">

    
    <link rel="alternative" href="/atom.xml" title="结绳以渔" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon_red_only_yao.ico">
    
    
    <link rel="apple-touch-icon" href="/img/red_logo_yao.png">
    <link rel="apple-touch-icon-precomposed" href="/img/red_logo_yao.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    <header>
      
<div class="header-container">
	<div class="logo-wrapper">
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo_red_yao.svg" alt="结绳以渔" title="结绳以渔"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="结绳以渔">结绳以渔</a></h1>
				<h2 class="blog-motto">临渊羡鱼，不如退而结网</h2>
			</div>
	</div>
	<div class="navbar">
		<a class="navbutton navmobile" href="#" title="Menu"></a>
	</div>
	<nav class="animated">
		<ul class="nav-list">
			
				<li><a href="/">主页</a></li>
			
				<li><a href="/archives">归档</a></li>
			
				<li><a href="/about">关于</a></li>
			
			<li>
			
			<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
				<label>Search</label>
				<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
				<input type="hidden" name="q" value="site:starding.github.io">
			</form>
			
			</li>
		</ul>
	</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<div class="article-header">
  <h1 itemprop="name">docker-gitlab 数据迁移</h1>
  <div class="article-info-meta">
    <p class="article-author">
      <a
        href="/about"
        title="XingHua"
        target="_blank"
        itemprop="author"
        >@XingHua</a
      >
    </p>

    <p class="article-time">
      <time datetime="2016-01-18T01:22:59.000Z" itemprop="datePublished">
          2016-01-18
      </time>
    </p>
  </div>
</div>

	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%9D%A5%E6%BA%90%EF%BC%9Adocker-%E7%9A%84-file-system-%E7%A5%9E%E5%9D%91"><span class="toc-number">1.</span> <span class="toc-text">问题来源：docker 的 file system 神坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gitlab-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">2.</span> <span class="toc-text">gitlab 数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">最终的解决办法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A%E4%B8%8B%E9%9D%A2%E6%98%AF%E5%8E%9F%E6%96%87%EF%BC%88%E5%B7%B2%E7%BF%BB%E8%AF%91%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">附录：下面是原文（已翻译）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%81%9C%E6%AD%A2-Gitlab-%E5%AE%B9%E5%99%A8"><span class="toc-number">3.1.</span> <span class="toc-text">1.停止 Gitlab 容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%87%E4%BB%BD%E6%89%80%E6%9C%89-Docker-Volumes-%E6%89%80%E6%9C%89%E7%9A%84-gitlab-%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">2.备份所有 Docker Volumes (所有的 gitlab 文件)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A4%87%E4%BB%BD-gitlab-%E9%95%9C%E5%83%8F%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.备份 gitlab 镜像（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4-gitlab-%E5%AE%B9%E5%99%A8-%E8%AF%91%E6%B3%A8%EF%BC%9A%E5%A6%82%E6%9E%9C%E4%BD%A0%E6%98%AF%E6%8A%8A%E6%95%B0%E6%8D%AE%E8%BF%81%E5%88%B0%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84-docker-gitlab-%E5%AE%9E%E4%BE%8B%E4%B8%8B%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%9C%AC%E6%AD%A5%E9%AA%A4%E5%8F%AF%E9%80%89"><span class="toc-number">3.4.</span> <span class="toc-text">4.删除 gitlab 容器 ( 译注：如果你是把数据迁到其他服务器的 docker gitlab 实例下的话，本步骤可选)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%8B%89%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84-gitlab-%E9%95%9C%E5%83%8F"><span class="toc-number">3.5.</span> <span class="toc-text">5.拉取最新的 gitlab 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%8B%89%E5%8F%96%E5%AE%8C%E6%AF%95%E5%90%8E%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">3.6.</span> <span class="toc-text">6.拉取完毕后，创建并运行容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%EF%BC%8C%E8%A7%82%E5%AF%9F%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%EF%BC%9A"><span class="toc-number">3.7.</span> <span class="toc-text">7.容器启动后，观察运行日志：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E7%84%B6%E5%90%8E%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E4%BB%A5%E5%8F%8A%E9%81%BF%E5%85%8D-3255-%E9%97%AE%E9%A2%98%E3%80%82"><span class="toc-number">3.8.</span> <span class="toc-text">8.然后我们需要检查数据库迁移是否成功以及避免#3255 问题。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E7%BB%A7%E7%BB%AD%E5%9C%A8%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8%E7%9A%84-bash-shell-%E4%B8%8A%EF%BC%8C%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AE-gitlab"><span class="toc-number">3.9.</span> <span class="toc-text">9.继续在容器内部的 bash shell 上，重新配置 gitlab:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%A6%82%E6%9E%9C%E4%B8%80%E5%88%87%E6%AD%A3%E5%B8%B8%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">3.10.</span> <span class="toc-text">10.如果一切正常，执行下面的命令：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E6%9C%80%E5%90%8E%EF%BC%8C%E6%B8%85%E9%99%A4-Redis-%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-number">3.11.</span> <span class="toc-text">11.最后，清除 Redis 的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">3.12.</span> <span class="toc-text">12.访问测试</span></a></li></ol></li></ol>
		
		</div>
		
		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="问题来源：docker-的-file-system-神坑"><a href="#问题来源：docker-的-file-system-神坑" class="headerlink" title="问题来源：docker 的 file system 神坑"></a>问题来源：docker 的 file system 神坑</h2><p>我们的 gitlab 是使用 docker 部署的，方便快捷。</p>
<p>但是后来服务器上的某个应用出现了内存泄露，没想到重启服务器之后整个 docker 就跪了，启动容器时总是遇到一系列比较底层的 filesystem unkown 错误，而且报错细节不止一种。调查之后，发现是 docker 使用的 devicemapper 出现了 bug，而且查看 docker 官方的 github，有不少人遇到这个 bug，讨论话题在此：<a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/4036">docker fails to mount the block device for the container on devicemapper</a>，感觉掉到一个深不见底的神坑里了。</p>
<p>stackoverflow 或 github 上给出的解决办法是：关掉 docker，删除&#x2F;var&#x2F;lib&#x2F;docker 中的所有内容，然后重启 gilab。我觉得可能是另一个神坑，没敢往里跳。于是选择慢慢研究这个问题，先在另外一台服务器上重新部署一下 gitlab，并且把数据迁移过去就行了。</p>
<h2 id="gitlab-数据迁移"><a href="#gitlab-数据迁移" class="headerlink" title="gitlab 数据迁移"></a>gitlab 数据迁移</h2><p>原以为迁移会很简单，没想到也有不少坑等着跳。</p>
<p>先把原服务器上的 gitlab 的 volumes 备份了一下，直接把备份好的 volumes 文件拷贝到新服务器上，按照原来的方法挂载，启动。</p>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>首先发现是 redis 啥啥没有权限，于是 google 了一番，把权限都改了。<br>然后出了一个 unfoudmethod 错误。调查是<a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-foss/-/commit/ff98c631c1004247656677568989e5ed68fc88f3">数据库没有 migrate</a> 的造成的。</p>
<p>还有一个隐藏的坑是 gitlab 的版本问题。类似的关键服务应用，尽量不要使用 latest 作为版本号，不然出了问题，还得去找自己使用的究竟是什么版本，如果找不到…准备拼人品吧。</p>
<h3 id="最终的解决办法"><a href="#最终的解决办法" class="headerlink" title="最终的解决办法"></a>最终的解决办法</h3><p>感觉这么一个一个坑的跳太二了，后来发现原来已经有人把坑都填好了：<a target="_blank" rel="noopener" href="https://cmanios.wordpress.com/2015/12/04/migrate-a-gitlab-docker-container-from-version-8-0-4-to-8-2-0/">Migrate a Gitlab Docker container from version 8.0.4 to 8.2.0</a></p>
<h2 id="附录：下面是原文（已翻译）"><a href="#附录：下面是原文（已翻译）" class="headerlink" title="附录：下面是原文（已翻译）"></a>附录：下面是原文（已翻译）</h2><p>前几天，我需要将 docker 部署的 gitlab 实例从 8.04 版迁移到 8.2.0 版本。我完全是按照 Gitlab Docker 镜像文档中的步骤进行的，但是出了一堆问题，简直日了狗。不过谢天谢地，在经过数小时的搜索挣扎之后，我终于搞定了。</p>
<p>在本教程中，假定 Gitlab 的 volumes 存储在 &#x2F;home&#x2F;bob&#x2F;docker-data&#x2F;gitlab 目录中 (当然，你需要根据你的实际目录结构来适当改写本教程)。然后下面是我成功迁移 gitlab 时遵循的所有步骤：</p>
<h3 id="1-停止-Gitlab-容器"><a href="#1-停止-Gitlab-容器" class="headerlink" title="1.停止 Gitlab 容器"></a>1.停止 Gitlab 容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop gitlab</span><br></pre></td></tr></table></figure>

<h3 id="2-备份所有-Docker-Volumes-所有的-gitlab-文件"><a href="#2-备份所有-Docker-Volumes-所有的-gitlab-文件" class="headerlink" title="2.备份所有 Docker Volumes (所有的 gitlab 文件)"></a>2.备份所有 Docker Volumes (所有的 gitlab 文件)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">backupDate=$(<span class="built_in">date</span> +<span class="string">&quot;%Y%m%d%H%M%S&quot;</span>) \</span><br><span class="line">  &amp;&amp; <span class="built_in">cd</span> /home/bob/docker-data/ \</span><br><span class="line">  &amp;&amp; sudo tar zvcf gitlab-data-<span class="variable">$&#123;backupDate&#125;</span>.tar.gz gitlab/</span><br></pre></td></tr></table></figure>

<h3 id="3-备份-gitlab-镜像（可选）"><a href="#3-备份-gitlab-镜像（可选）" class="headerlink" title="3.备份 gitlab 镜像（可选）"></a>3.备份 gitlab 镜像（可选）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o /home/bob/gitlab-ce-image.tar gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>
<h3 id="4-删除-gitlab-容器-译注：如果你是把数据迁到其他服务器的-docker-gitlab-实例下的话，本步骤可选"><a href="#4-删除-gitlab-容器-译注：如果你是把数据迁到其他服务器的-docker-gitlab-实例下的话，本步骤可选" class="headerlink" title="4.删除 gitlab 容器 ( 译注：如果你是把数据迁到其他服务器的 docker gitlab 实例下的话，本步骤可选)"></a>4.删除 gitlab 容器 ( 译注：如果你是把数据迁到其他服务器的 docker gitlab 实例下的话，本步骤可选)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> gitlab</span><br></pre></td></tr></table></figure>

<h3 id="5-拉取最新的-gitlab-镜像"><a href="#5-拉取最新的-gitlab-镜像" class="headerlink" title="5.拉取最新的 gitlab 镜像"></a>5.拉取最新的 gitlab 镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<h3 id="6-拉取完毕后，创建并运行容器"><a href="#6-拉取完毕后，创建并运行容器" class="headerlink" title="6.拉取完毕后，创建并运行容器"></a>6.拉取完毕后，创建并运行容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --hostname 192.168.1.1 \</span><br><span class="line">  --publish 8443:443 --publish 8082:80 --publish 2224:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /etc/localtime:/etc/localtime \</span><br><span class="line">  --volume /home/bob/docker-data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /home/bob/docker-data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /home/bob/docker-data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<h3 id="7-容器启动后，观察运行日志："><a href="#7-容器启动后，观察运行日志：" class="headerlink" title="7.容器启动后，观察运行日志："></a>7.容器启动后，观察运行日志：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f --<span class="built_in">tail</span> 10 gitlab</span><br></pre></td></tr></table></figure>
<p>日志内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[2015-11-26T15:12:26+02:00] INFO: Retrying execution of execute[create gitlab database user], 19 attempt(s) left</span><br><span class="line">[2015-11-26T15:12:28+02:00] INFO: Retrying execution of execute[create gitlab database user], 18 attempt(s) left</span><br><span class="line">... (some lines omitted) ...</span><br><span class="line">[2015-11-26T15:13:09+02:00] INFO: Retrying execution of execute[create gitlab database user], 0 attempt(s) left</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Error executing action `run` on resource &#x27;execute[create gitlab database user]&#x27;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Mixlib::ShellOut::ShellCommandFailed</span><br><span class="line"> </span><br><span class="line">Expected process to exit with [0], but received &#x27;2&#x27;</span><br><span class="line">---- Begin output of /opt/gitlab/embedded/bin/psql --port 5432 -h /var/opt/gitlab/postgresql -d template1 -c &quot;CREATE USER gitlab&quot; ----</span><br><span class="line">STDOUT: </span><br><span class="line">STDERR: psql: could not connect to server: No such file or directory</span><br><span class="line">Is the server running locally and accepting</span><br><span class="line">connections on Unix domain socket &quot;/var/opt/gitlab/postgresql/.s.PGSQL.5432&quot;?</span><br><span class="line">---- End output of /opt/gitlab/embedded/bin/psql --port 5432 -h /var/opt/gitlab/postgresql -d template1 -c &quot;CREATE USER gitlab&quot; ----</span><br><span class="line">Ran /opt/gitlab/embedded/bin/psql --port 5432 -h /var/opt/gitlab/postgresql -d template1 -c &quot;CREATE USER gitlab&quot; returned 2</span><br><span class="line"> </span><br><span class="line">Resource Declaration:</span><br><span class="line"> </span><br><span class="line"># In /opt/gitlab/embedded/cookbooks/cache/cookbooks/gitlab/recipes/postgresql.rb</span><br><span class="line"> </span><br><span class="line">153:   execute &quot;create #&#123;sql_user&#125; database user&quot; do</span><br><span class="line">154:     command &quot;#&#123;bin_dir&#125;/psql --port #&#123;pg_port&#125; -h #&#123;postgresql_socket_dir&#125; -d template1 -c \&quot;CREATE USER #&#123;sql_user&#125;\&quot;&quot;</span><br><span class="line">155:     user postgresql_user</span><br><span class="line">156:     # Added retries to give the service time to start on slower systems</span><br><span class="line">157:     retries 20</span><br><span class="line">158:     not_if &#123; !pg_helper.is_running? || pg_helper.user_exists?(sql_user) &#125;</span><br><span class="line">159:   end</span><br><span class="line">160: </span><br><span class="line"> </span><br><span class="line">Compiled Resource:</span><br><span class="line"> </span><br><span class="line"># Declared in /opt/gitlab/embedded/cookbooks/cache/cookbooks/gitlab/recipes/postgresql.rb:153:in `block in from_file&#x27;</span><br><span class="line"> </span><br><span class="line">execute(&quot;create gitlab database user&quot;) do</span><br><span class="line">action [:run]</span><br><span class="line">retries 20</span><br><span class="line">retry_delay 2</span><br><span class="line">default_guard_interpreter :execute</span><br><span class="line">command &quot;/opt/gitlab/embedded/bin/psql --port 5432 -h /var/opt/gitlab/postgresql -d template1 -c \&quot;CREATE USER gitlab\&quot;&quot;</span><br><span class="line">backup 5</span><br><span class="line">returns 0</span><br><span class="line">user &quot;gitlab-psql&quot;</span><br><span class="line">declared_type :execute</span><br><span class="line">cookbook_name &quot;gitlab&quot;</span><br><span class="line">recipe_name &quot;postgresql&quot;</span><br><span class="line">not_if &#123; #code block &#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>有两个已知的权限问题，在 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/omnibus/docker/">official documentation</a> 和 <a target="_blank" rel="noopener" href="https://github.com/gitlabhq/gitlabhq/issues/9611">#9611</a> 中描述。为了解决这两个问题，执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab update-permissions</span><br><span class="line">docker <span class="built_in">exec</span> gitlab <span class="built_in">chown</span> -R gitlab-redis /var/opt/gitlab/redis</span><br></pre></td></tr></table></figure>

<p>然后重启 gitlab 容器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart gitlab</span><br></pre></td></tr></table></figure>

<h3 id="8-然后我们需要检查数据库迁移是否成功以及避免-3255-问题。"><a href="#8-然后我们需要检查数据库迁移是否成功以及避免-3255-问题。" class="headerlink" title="8.然后我们需要检查数据库迁移是否成功以及避免#3255 问题。"></a>8.然后我们需要检查数据库迁移是否成功以及避免#3255 问题。</h3><p>登录到 gitlab 容器中的 shell：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -t -i gitlab /bin/bash</span><br></pre></td></tr></table></figure>

<p>检查数据库迁移状况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake db:migrate:status</span><br></pre></td></tr></table></figure>

<p>如果所有状态都显示为 up 状态，是没问题的。如果发现 down 状态，类似下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">up     20150920161119  Add line code to sent notification</span><br><span class="line">down    20150924125150  Add project id to ci commit</span><br><span class="line">down    20150924125436  Migrate project id for ci commits</span><br></pre></td></tr></table></figure>
<p>就必须重新手动执行数据库 migration 命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake db:migrate</span><br></pre></td></tr></table></figure>
<p>当执行结束时，重新检查数据库 migrate 状态，确保所有状态都为 up：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake db:migrate:status</span><br></pre></td></tr></table></figure>

<h3 id="9-继续在容器内部的-bash-shell-上，重新配置-gitlab"><a href="#9-继续在容器内部的-bash-shell-上，重新配置-gitlab" class="headerlink" title="9.继续在容器内部的 bash shell 上，重新配置 gitlab:"></a>9.继续在容器内部的 bash shell 上，重新配置 gitlab:</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<p>然后检查是不是所有内容都正常运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake gitlab:check</span><br></pre></td></tr></table></figure>

<h3 id="10-如果一切正常，执行下面的命令："><a href="#10-如果一切正常，执行下面的命令：" class="headerlink" title="10.如果一切正常，执行下面的命令："></a>10.如果一切正常，执行下面的命令：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake gitlab:<span class="built_in">env</span>:info RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>会返回类似下面这样的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">System information</span><br><span class="line">System:   Ubuntu 14.04</span><br><span class="line">Current User: git</span><br><span class="line">Using RVM:  no</span><br><span class="line">Ruby Version: 2.1.7p400</span><br><span class="line">Gem Version:  2.2.5</span><br><span class="line">Bundler Version:1.10.6</span><br><span class="line">Rake Version: 10.4.2</span><br><span class="line">Sidekiq Version:3.3.0</span><br><span class="line"> </span><br><span class="line">GitLab information</span><br><span class="line">Version:  8.2.0</span><br><span class="line">Revision: d6bcf44</span><br><span class="line">Directory:  /opt/gitlab/embedded/service/gitlab-rails</span><br><span class="line">DB Adapter: postgresql</span><br><span class="line">URL:    http://192.168.1.1:8082</span><br><span class="line">HTTP Clone URL: http://192.168.1.1:8082/some-group/some-project.git</span><br><span class="line">SSH Clone URL:  git@192.168.1.1:some-group/some-project.git</span><br><span class="line">Using LDAP: yes</span><br><span class="line">Using Omniauth: no</span><br><span class="line"> </span><br><span class="line">GitLab Shell</span><br><span class="line">Version:  2.6.7</span><br><span class="line">Repositories: /var/opt/gitlab/git-data/repositories</span><br><span class="line">Hooks:    /opt/gitlab/embedded/service/gitlab-shell/hooks/</span><br><span class="line">Git:    /opt/gitlab/embedded/bin/git</span><br></pre></td></tr></table></figure>

<h3 id="11-最后，清除-Redis-的缓存"><a href="#11-最后，清除-Redis-的缓存" class="headerlink" title="11.最后，清除 Redis 的缓存"></a>11.最后，清除 Redis 的缓存</h3><p>不然可能会遇到这个问题： <a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/3619">#3619</a> 或这个问题 <a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/3609">#3609</a>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rake cache:clear</span><br></pre></td></tr></table></figure>

<h3 id="12-访问测试"><a href="#12-访问测试" class="headerlink" title="12.访问测试"></a>12.访问测试</h3><p>完成上述步骤之后，访问 <a target="_blank" rel="noopener" href="http://localhost:8082/">http://localhost:8082</a> 应该能正常登陆</p>
  
	</div>
		<footer class="article-footer">
  <div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E4%BD%9C%E4%B8%BA%E5%B7%A5%E7%A8%8B%E5%B8%88/">作为工程师</a>
</div>


</div>

 
  <div class="article-share" id="share">
    <div
      data-url="http://starding.github.io/2016/01/18/gitlab-migrate/"
      data-title="docker-gitlab 数据迁移 | 结绳以渔"
      data-tsina=""
      class="share"
    ></div>
  </div>
   
</footer>
   	       
	</article>
	
<nav class="article-nav">
 
 <div class="prev" >
    <a href="/2016/01/19/learn-javascript-follow-definitive-guide/" title="javascript 犀牛书（第六版）">
      <span>javascript 犀牛书（第六版）</span>
    </a>
  </div>

  
  <div class="next">
    <a href="/2016/01/15/learn-in-computer-sciense/"  title="计算机领域中的概念辨析">
      <span>计算机领域中的概念辨析</span>
    </a>
  </div>
  
</nav>

	
<section id="comments" class="comment">
  <script src="https://giscus.app/client.js"
          data-repo="starding/xinghua_blog_giscus"
          data-repo-id="R_kgDOLagm8g"
          data-category="Announcements"
          data-category-id="DIC_kwDOLagm8s4CdqOC"
          data-mapping="og:title"
          data-strict="1"
          data-reactions-enabled="1"
          data-emit-metadata="1"
          data-input-position="top"
          data-theme="noborder_light"
          data-lang="zh-CN"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%9D%A5%E6%BA%90%EF%BC%9Adocker-%E7%9A%84-file-system-%E7%A5%9E%E5%9D%91"><span class="toc-number">1.</span> <span class="toc-text">问题来源：docker 的 file system 神坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gitlab-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">2.</span> <span class="toc-text">gitlab 数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">最终的解决办法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A%E4%B8%8B%E9%9D%A2%E6%98%AF%E5%8E%9F%E6%96%87%EF%BC%88%E5%B7%B2%E7%BF%BB%E8%AF%91%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">附录：下面是原文（已翻译）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%81%9C%E6%AD%A2-Gitlab-%E5%AE%B9%E5%99%A8"><span class="toc-number">3.1.</span> <span class="toc-text">1.停止 Gitlab 容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%87%E4%BB%BD%E6%89%80%E6%9C%89-Docker-Volumes-%E6%89%80%E6%9C%89%E7%9A%84-gitlab-%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">2.备份所有 Docker Volumes (所有的 gitlab 文件)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A4%87%E4%BB%BD-gitlab-%E9%95%9C%E5%83%8F%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.备份 gitlab 镜像（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4-gitlab-%E5%AE%B9%E5%99%A8-%E8%AF%91%E6%B3%A8%EF%BC%9A%E5%A6%82%E6%9E%9C%E4%BD%A0%E6%98%AF%E6%8A%8A%E6%95%B0%E6%8D%AE%E8%BF%81%E5%88%B0%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84-docker-gitlab-%E5%AE%9E%E4%BE%8B%E4%B8%8B%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%9C%AC%E6%AD%A5%E9%AA%A4%E5%8F%AF%E9%80%89"><span class="toc-number">3.4.</span> <span class="toc-text">4.删除 gitlab 容器 ( 译注：如果你是把数据迁到其他服务器的 docker gitlab 实例下的话，本步骤可选)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%8B%89%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84-gitlab-%E9%95%9C%E5%83%8F"><span class="toc-number">3.5.</span> <span class="toc-text">5.拉取最新的 gitlab 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%8B%89%E5%8F%96%E5%AE%8C%E6%AF%95%E5%90%8E%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">3.6.</span> <span class="toc-text">6.拉取完毕后，创建并运行容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%EF%BC%8C%E8%A7%82%E5%AF%9F%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%EF%BC%9A"><span class="toc-number">3.7.</span> <span class="toc-text">7.容器启动后，观察运行日志：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E7%84%B6%E5%90%8E%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%E4%BB%A5%E5%8F%8A%E9%81%BF%E5%85%8D-3255-%E9%97%AE%E9%A2%98%E3%80%82"><span class="toc-number">3.8.</span> <span class="toc-text">8.然后我们需要检查数据库迁移是否成功以及避免#3255 问题。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E7%BB%A7%E7%BB%AD%E5%9C%A8%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8%E7%9A%84-bash-shell-%E4%B8%8A%EF%BC%8C%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AE-gitlab"><span class="toc-number">3.9.</span> <span class="toc-text">9.继续在容器内部的 bash shell 上，重新配置 gitlab:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%A6%82%E6%9E%9C%E4%B8%80%E5%88%87%E6%AD%A3%E5%B8%B8%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">3.10.</span> <span class="toc-text">10.如果一切正常，执行下面的命令：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E6%9C%80%E5%90%8E%EF%BC%8C%E6%B8%85%E9%99%A4-Redis-%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-number">3.11.</span> <span class="toc-text">11.最后，清除 Redis 的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">3.12.</span> <span class="toc-text">12.访问测试</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/作为工程师/" title="作为工程师">作为工程师<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/科哲和科学史/" title="科哲和科学史">科哲和科学史<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://finaltheory.me/" target="_blank" title=" 18~26 岁期间对我影响很大的同学">黄龑</a>
            
          </li>
        
          <li>
            
            	<a href="https://chuan.us" target="_blank" title=" 虽然不认识，但 30 岁之后我从他的言论中学到了很多">硅谷王川</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer-wrapper">
  <div id="footer">
    <section class="author-area-container">
      <section class="author-area">
        
        <div class="line">
          <span></span>
          <div class="author"></div>
        </div>
         
        
        <section class="info">
          <p>
            人存于世，因缘际会 <br />
            我是兴华，很高兴见到你
          </p>
        </section>
        
      </section>
      <div class="social-font" class="clearfix">
         
        <a
          href="https://github.com/starding"
          target="_blank"
          class="icon-github"
          title="github"
        ></a>
          
        <a
          href="https://twitter.com/starstarding"
          target="_blank"
          class="icon-twitter"
          title="twitter"
        ></a>
             
        
        
        <a
          href="mailto:starstarding@gmail.com"
          target="_blank"
          class="icon-email"
          title="Email Me"
        ></a>
        
      </div>
       
    </section>
    <p class="copyright">
      Powered by
      <a href="http://hexo.io" target="_blank" title="hexo">Hexo</a>
      and Theme by
      <a
        href="https://github.com/starding/hexo-theme-xman"
        target="_blank"
        title="xman"
        >xman</a>
      © 2016~2024 
      <a
        href="/about"
        target="_blank"
        title="XingHua"
        >XingHua</a
      >
      
    </p>
  </div>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
  $(document).ready(function(){
    $('.navbar').click(function(){
      $('header nav').toggleClass('shownav');
    });
    var myWidth = 0;
    function getSize(){
      if( typeof( window.innerWidth ) == 'number' ) {
        myWidth = window.innerWidth;
      } else if( document.documentElement && document.documentElement.clientWidth) {
        myWidth = document.documentElement.clientWidth;
      };
    };
    var m = $('#main'),
        a = $('#asidepart'),
        c = $('.closeaside'),
        o = $('.openaside');
    c.click(function(){
      a.addClass('fadeOut').css('display', 'none');
      o.css('display', 'block').addClass('fadeIn');
      m.addClass('moveMain');
    });
    o.click(function(){
      o.css('display', 'none').removeClass('beforeFadeIn');
      a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
      m.removeClass('moveMain');
    });
    $(window).scroll(function(){
      o.css("top",Math.max(80,260-$(this).scrollTop()));
    });
    
    $(window).resize(function(){
      getSize();
      if (myWidth >= 1024) {
        $('header nav').removeClass('shownav');
      }else{
        m.removeClass('moveMain');
        a.css('display', 'block').removeClass('fadeOut');
        o.css('display', 'none');
        
        $('#toc.toc-aside').css('display', 'none');
        
      }
    });
  });
</script>

<script type="text/javascript">
  $(document).ready(function () {
    var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t = $('#toc'),
      ta = $('#toc.toc-aside'),
      o = $('.openaside'),
      c = $('.closeaside')
    if (ai.length > 0) {
      ai.wrap('<div class="video-container" />')
    }
    if (ae.length > 0) {
      ae.wrap('<div class="video-container" />')
    }
    c.click(function () {
      ta.css('display', 'block').addClass('fadeIn')
    })
    o.click(function () {
      ta.css('display', 'none')
    })
    $(window).scroll(function () {
      ta.css('top', Math.max(140, 320 - $(this).scrollTop()))
    })
  })
</script>
 
<script type="text/javascript">
  $(document).ready(function () {
    var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description')
    var html = [
      '<span title="Share to"></span>',
      '<div class="hoverqrcode clearfix"></div>',
      '<a class="overlay" id="qrcode"></a>',
      '<a href="https://twitter.com/intent/tweet?url=' +
        encodedUrl +
        '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
      '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
    ].join('')
    
    $this.append(html)

    $('.hoverqrcode').hide()

    var myWidth = 0
    function updatehoverqrcode() {
      if (typeof window.innerWidth == 'number') {
        myWidth = window.innerWidth
      } else if (
        document.documentElement &&
        document.documentElement.clientWidth
      ) {
        myWidth = document.documentElement.clientWidth
      }
      var qrsize = myWidth > 1024 ? 200 : 100
      var options = {
        render: 'image',
        size: qrsize,
        fill: '#2ca6cb',
        text: url,
        radius: 0.5,
        quiet: 1,
      }
      var p = $('.article-share-qrcode').position()
      $('.hoverqrcode')
        .empty()
        .css('width', qrsize)
        .css('height', qrsize)
        .css('left', p.left - qrsize / 2 + 20)
        .css('top', p.top - qrsize - 10)
        .qrcode(options)
    }
    $(window).resize(function () {
      $('.hoverqrcode').hide()
    })
    $('.article-share-qrcode').click(function () {
      updatehoverqrcode()
      $('.hoverqrcode').toggle()
    })
    $('.article-share-qrcode').hover(
      function () {},
      function () {
        $('.hoverqrcode').hide()
      }
    )
  })
</script>
  

  
<link
  rel="stylesheet"
  href="/fancybox/jquery.fancybox.css"
  media="screen"
  type="text/css"
/>
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    $('.article-content').each(function (i) {
      $(this)
        .find('img')
        .each(function () {
          if ($(this).parent().hasClass('fancybox')) return
          var alt = this.alt
          if (alt) $(this).after('<span class="caption">' + alt + '</span>')
          $(this).wrap(
            '<a href="' +
              this.src +
              '" title="' +
              alt +
              '" class="fancybox"></a>'
          )
        })
      $(this)
        .find('.fancybox')
        .each(function () {
          $(this).attr('rel', 'article' + i)
        })
    })
    if ($.fancybox) {
      $('.fancybox').fancybox()
    }
  })
</script>


<!-- Analytics Begin -->

 <!-- Google tag (gtag.js) -->
    <script async
        src="https://www.googletagmanager.com/gtag/js?id=G-K5Z9WLE5XK">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config',
        'G-K5Z9WLE5XK');
    </script>


    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src =
                "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.svg"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
