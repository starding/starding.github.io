
 <!DOCTYPE HTML>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
    <title>使用 daocloud 持续集成应用 | 结绳以渔</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="XingHua">
    

    
    <meta name="description" content="写在前面的话来自维基百科的：货殖崇拜编程 为因 GFW 屏蔽访问不了维基百科的同学准备的：  货物崇拜编程（Cargo Cult Programming）是一种计算机程序设计中的反模式，其特征为不明就里地、仪式性地使用代码或程序架构。货物崇拜编程通常是程序员既没理解他要解决的 bug、也没理解表面上的解决方案的典型表现。   这个名词有时也指不熟练的或没经验的程序员从某处拷贝代码到另一处，却不太清">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 daocloud 持续集成应用">
<meta property="og:url" content="http://starding.github.io/2016/01/07/daocloud-deploy/index.html">
<meta property="og:site_name" content="结绳以渔">
<meta property="og:description" content="写在前面的话来自维基百科的：货殖崇拜编程 为因 GFW 屏蔽访问不了维基百科的同学准备的：  货物崇拜编程（Cargo Cult Programming）是一种计算机程序设计中的反模式，其特征为不明就里地、仪式性地使用代码或程序架构。货物崇拜编程通常是程序员既没理解他要解决的 bug、也没理解表面上的解决方案的典型表现。   这个名词有时也指不熟练的或没经验的程序员从某处拷贝代码到另一处，却不太清">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-01-06T23:24:25.000Z">
<meta property="article:modified_time" content="2024-02-29T13:32:41.893Z">
<meta property="article:author" content="XingHua">
<meta property="article:tag" content="投资，计算机，科学哲学，技术哲学">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@starstarding">

    
    <link rel="alternative" href="/atom.xml" title="结绳以渔" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon_red_only_yao.ico">
    
    
    <link rel="apple-touch-icon" href="/img/red_logo_yao.png">
    <link rel="apple-touch-icon-precomposed" href="/img/red_logo_yao.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo_red_big_yao.png" alt="结绳以渔" title="结绳以渔"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="结绳以渔">结绳以渔</a></h1>
				<h2 class="blog-motto">临渊羡鱼，不如退而结网</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:starding.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">使用 daocloud 持续集成应用</h1>
  <div class="article-info-meta">
    <p class="article-author">
      
      <a
        href="/about"
        title="XingHua"
        target="_blank"
        itemprop="author"
        >@XingHua</a
      >
      
    </p>

    <p class="article-time">
      <time datetime="2016-01-06T23:24:25.000Z" itemprop="datePublished">
        On 2016-01-07</time
      >
    </p>
  </div>
</header>

	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E8%AF%9D"><span class="toc-number">1.</span> <span class="toc-text">写在前面的话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#daocloud-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">daocloud 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%AE%80%E5%8D%95%E7%9A%84-html5-%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">持续集成简单的 html5 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%B0%8F%E8%8A%82%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.1.</span> <span class="toc-text">本小节使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E3%80%8C%E7%AE%80%E5%8D%95%E7%9A%84-html5-%E5%BA%94%E7%94%A8%E3%80%8D"><span class="toc-number">3.2.</span> <span class="toc-text">什么是「简单的 html5 应用」</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%A4%A7%E8%87%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.3.</span> <span class="toc-text">部署大致解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">3.4.</span> <span class="toc-text">构建应用前的准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.4.1.</span> <span class="toc-text">应用目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Dockerfile-%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">创建 Dockerfile 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9C%A8-docker-%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82"><span class="toc-number">3.4.3.</span> <span class="toc-text">配置在 docker 中使用的 nginx 配置文件。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-daocloud-%E8%BF%9B%E8%A1%8C%E6%8C%81%E7%BB%AD%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%BB%A5%E5%8F%8A%E5%8F%91%E5%B8%83"><span class="toc-number">3.5.</span> <span class="toc-text">使用 daocloud 进行持续构建镜像以及发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.6.</span> <span class="toc-text">发布完成之后需要做的工作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BE%9D%E8%B5%96%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">持续集成依赖外部服务的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E9%80%82%E7%94%A8%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">4.1.</span> <span class="toc-text">本文适用的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">依赖外部服务的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">4.3.</span> <span class="toc-text">构建前的准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Makefile-%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="toc-number">4.3.2.</span> <span class="toc-text">Makefile 文件编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81"><span class="toc-number">4.3.3.</span> <span class="toc-text">静态文件支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%9D%A5%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.4.</span> <span class="toc-text">通过环境变量来连接服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-daocloud-%E9%83%A8%E7%BD%B2%E6%9E%84%E5%BB%BA%E5%A5%BD%E7%9A%84-taikang-%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.4.</span> <span class="toc-text">使用 daocloud 部署构建好的 taikang 项目</span></a></li></ol></li></ol>
		
		</div>
		
		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h2><p>来自维基百科的：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B4%A7%E7%89%A9%E5%B4%87%E6%8B%9C%E7%BC%96%E7%A8%8B">货殖崇拜编程</a></p>
<p>为因 GFW 屏蔽访问不了维基百科的同学准备的：</p>
<blockquote>
<p>货物崇拜编程（Cargo Cult Programming）是一种计算机程序设计中的反模式，其特征为不明就里地、仪式性地使用代码或程序架构。货物崇拜编程通常是程序员既没理解他要解决的 bug、也没理解表面上的解决方案的典型表现。</p>
</blockquote>
<blockquote>
<p>这个名词有时也指不熟练的或没经验的程序员从某处拷贝代码到另一处，却不太清楚其代码是如何工作的，或者不清楚在新的地方是否需要这段代码。也可以指不正确或过份的应用设计模式、代码风格或编程方法，却对其原理不明就里。</p>
</blockquote>
<blockquote>
<p>货物崇拜编程来源于“货物崇拜”这个词。其衍生词还有“货物崇拜软件工程”。</p>
</blockquote>
<p>在阅读任何教程类的文章时，都不要有编程上的货殖崇拜，有些内容是需要你根据自己的实际情况修改一些内容的，需要你理解它，如果不理解某些内容，就需要先熟悉一下相关的知识。</p>
<h2 id="daocloud-介绍"><a href="#daocloud-介绍" class="headerlink" title="daocloud 介绍"></a>daocloud 介绍</h2><p>daocloud 提供基于 docker 进行持续集成的服务，使用它可以很方便的完成项目的自动化构建以及持续发布等功能。</p>
<p>当然，如果要使用 daocloud 持续化集成应用，首先你需要注册一个 daocloud 账号。如果你效力于某个公司的话，还要通知该公司把你的账号拉到公司用户组里，这样才能使用该公司的资源。</p>
<h2 id="持续集成简单的-html5-应用"><a href="#持续集成简单的-html5-应用" class="headerlink" title="持续集成简单的 html5 应用"></a>持续集成简单的 html5 应用</h2><h3 id="本小节使用场景"><a href="#本小节使用场景" class="headerlink" title="本小节使用场景"></a>本小节使用场景</h3><ul>
<li>拥有自己的主机</li>
<li>将主机添加到了 daocloud 上</li>
<li>只使用 daocloud 的自动构建和部署功能</li>
<li>镜像也要部署到自己的主机上。</li>
</ul>
<h3 id="什么是「简单的-html5-应用」"><a href="#什么是「简单的-html5-应用」" class="headerlink" title="什么是「简单的 html5 应用」"></a>什么是「简单的 html5 应用」</h3><p>只有前端页面，并且使用 nginx 提供服务。</p>
<h3 id="部署大致解决方案"><a href="#部署大致解决方案" class="headerlink" title="部署大致解决方案"></a>部署大致解决方案</h3><p>本文假设一个使用场景：拥有自己的主机，并且绑定到了 daocloud 上，然后想通过 daocloud 进行持续化地部署到自己的主机上。如果想要部署一个纯前端项目，需要把 nginx 集成进去，然后使用 nginx 来提供服务。</p>
<h3 id="构建应用前的准备"><a href="#构建应用前的准备" class="headerlink" title="构建应用前的准备"></a>构建应用前的准备</h3><h4 id="应用目录结构"><a href="#应用目录结构" class="headerlink" title="应用目录结构"></a>应用目录结构</h4><p>因为 daocloud 是基于 daocker 的，在使用 daocloud 之前，我们需要按照 docker 的规范，把自己的项目改成支持打包成镜像的应用，对于 html5 项目来说，就是添加 Dockerfile 文件和配置好所需要的 nginx 配置文件。比如我有一个应用叫 jinli，其目录结构为 (你的目录结构和这个可能也不一样)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jinli/  # 项目根目录</span><br><span class="line">├── jinli/  # 具体的应用目录</span><br><span class="line">│   ├── images/ # 图片</span><br><span class="line">│   ├── index.html  # 默认的检索 html</span><br><span class="line">│   ├── scripts/  #  js 文件夹</span><br><span class="line">│   └── styles/    # 存放 css 的文件夹</span><br><span class="line">├── Dockerfile   # Dockerfile</span><br><span class="line">├── jinli.conf   # 本应用的 nginx 配置文件</span><br><span class="line">└── log/  # log 文件</span><br></pre></td></tr></table></figure>
<p>在这个目录结构中，和 docker 镜像构建是就是 Dockerfile 这个文件，jinli.conf 是个将要一起打包放入 docker 镜像中的文件，其他的都是应用本身的文件。</p>
<h4 id="创建-Dockerfile-文件"><a href="#创建-Dockerfile-文件" class="headerlink" title="创建 Dockerfile 文件"></a>创建 Dockerfile 文件</h4><p>Dockerfile，就是一个 daocker 的规则文件，就像 make 的 Makefile 一样。Dockerfile 描述了将自己的应用构建成 docker 镜像的过程。<br>在本例中，Dockerfile 的内容如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择 nginx 服务</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.9</span>.<span class="number">5</span></span><br><span class="line"><span class="comment"># copy 代码</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /src</span></span><br><span class="line"><span class="comment"># 添加 nginx 配置文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> jinli.conf /etc/nginx/conf.d/</span></span><br><span class="line"><span class="comment"># 去掉默认的 nginx 配置文件</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> /etc/nginx/conf.d/default.conf</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile 解释：</p>
<ul>
<li>首先，想象将要构建的 docker 镜像包含一个 linux 操作系统。</li>
<li><code>FROM nginx:1.9.5</code> 的意思就是，将 1.9.5 版本的 nginx 服务集成到自己的镜像中（其实操作系统就是在这一步引入的，nginx 本身也是一个镜像，它是建立在一个 linux 操作系统之上的，拉取 nginx 的时候，会连把 nginx 连带其附着的 linx 系统整个一起拉下来）。</li>
<li><code>COPY . /src</code> 的意思是将当前目录下的代码复制到镜像中（的操作系统中）的 &#x2F;src 目录下</li>
<li><code>COPY jinli.conf /etc/nginx/conf.d/</code> 的意思是，将当前目录下写好的 nginx 配置文件，复制到镜像（的操作系统）中的相应目录下。</li>
<li>删掉原来默认的 nginx 配置（因为默认配置文件会占用掉 localhost，不知道有没有更好的解决办法）</li>
</ul>
<h4 id="配置在-docker-中使用的-nginx-配置文件。"><a href="#配置在-docker-中使用的-nginx-配置文件。" class="headerlink" title="配置在 docker 中使用的 nginx 配置文件。"></a>配置在 docker 中使用的 nginx 配置文件。</h4><p>本示例中，nginx 配置文件命名为 jinli.conf。把它打包到镜像中，来给 html5 应用提供服务，这与平时直接在服务器上部署没有什么很大的差别，需要注意的就是：</p>
<ul>
<li>server_name 为 localhost，因为这个 server_name 是在 docker 容器内部使用的。</li>
<li>location 中的 root 文件夹是 docker 容器中的地址，不是宿主机的地址</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="attribute">access_log</span> /src/log/jinli.access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /src/log/jinli.<span class="literal">error</span>.log;</span><br><span class="line">    <span class="comment"># 这里你还可以选择根据需要配一些 gzip 等选项</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /src/jinli/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将应用提交到 github 上，比如具体为：xiaohuruwei&#x2F;jinli.git</p>
<p>以上已经包含全部必须的材料了，下面进入 daocloud 环节。</p>
<h3 id="使用-daocloud-进行持续构建镜像以及发布"><a href="#使用-daocloud-进行持续构建镜像以及发布" class="headerlink" title="使用 daocloud 进行持续构建镜像以及发布"></a>使用 daocloud 进行持续构建镜像以及发布</h3><p>因为前面的步骤已经构建好了一个支持 docker 的代码版本，而且不需要外联像 mysql 这样的外部服务，因此可以直接将其当做一个单应用的镜像来构建。</p>
<p>在这方面，daocloud 已经有了完善的文档，可以直接参考其中的创建新项目章节，以及持续集成章节。</p>
<p>第四节创建新项目，根据具体情况选择要绑定需要的 git 源<br>第五节持续集成和镜像构建，在简单的 html 部署中，不需要了解 daocloud.yml 的写法<br>第九节中的向自由主机集群上发布应用</p>
<p>在上面的过程中，核心部分如下：</p>
<ul>
<li>绑定 git 源</li>
<li>选择要部署的 git 仓库，并构建成镜像</li>
<li>部署到自有主机上</li>
<li>将后续自动持续部署的设置打开</li>
<li>在「代码构建」具体项目的「设置」中，将持续集成打开，设置好镜像和持续集成的触发规则，比如：在向 docker-support 分支提交代码时，就触发自动持续集成。</li>
<li>在「应用列表」中的「发布」设置中，将自动发布打开。</li>
</ul>
<h3 id="发布完成之后需要做的工作"><a href="#发布完成之后需要做的工作" class="headerlink" title="发布完成之后需要做的工作"></a>发布完成之后需要做的工作</h3><p>发布完成之后，可以在 daocloud 上看到所创建的容器的具体信息。包括映射到宿主机上的端口号等等，点击端口号后可以看到该应用的访问地址，打开可以测试是否部署成功了</p>
<p>为方便后面的叙述，这里假设映射出的端口号为 8888。因为是发布到自己的主机上，所以还需要自己配置域名以及 nginx 反向代理来对外提供访问服务。假设有一个域名已经绑定在了自己的主机上，这里假设为 xiaohuruwei.com.</p>
<p>登陆自己的主机，并配置 nginx 文件，如果是使用 apt-get 一类的包管理工具安装的，那么应该是在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;目录下添加 jinli.conf:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xiaohuruwei.com;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/jinli.access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/jinli.<span class="literal">error</span>.log;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">200m</span>;</span><br><span class="line">    <span class="comment"># 可以根据需要设置其他配置项</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8888;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后访问 xiaohuruwei.com 就可以看到内容了</p>
<p>另外，需要在使用 daocloud 的时候，将自动构建和持续发布都打开，这样下次使用时，只需要往 github 推代码时，触发了你设定的更新规则，就会持续构建镜像并发布了。</p>
<h2 id="持续集成依赖外部服务的应用"><a href="#持续集成依赖外部服务的应用" class="headerlink" title="持续集成依赖外部服务的应用"></a>持续集成依赖外部服务的应用</h2><p>以 django 应用为例</p>
<h3 id="本文适用的场景"><a href="#本文适用的场景" class="headerlink" title="本文适用的场景"></a>本文适用的场景</h3><ul>
<li>拥有自己的主机</li>
<li>将主机添加到了 daocloud 上</li>
<li>只使用 daocloud 的自动构建和部署功能<br>所依赖的外部服务已经（以 daocke 容器）存在于自己的主机上，镜像也要部署在自己的主机上。在部署的同时连接主机上已经存在的外部服务（如 mysql，redis 等）。</li>
</ul>
<h3 id="依赖外部服务的应用"><a href="#依赖外部服务的应用" class="headerlink" title="依赖外部服务的应用"></a>依赖外部服务的应用</h3><p>在 docker 领域中，如果一个 docker 镜像自身需要其他镜像来提供服务，就说这个镜像是带外部服务的。</p>
<p>以一个简单的 django 应用为例，如果这个 django 应用自身无法完成任务，而需要 mysql 或者其他数据库作为数据的持久化服务，那么这个 django 应用就是依赖外部服务的。</p>
<h3 id="构建前的准备"><a href="#构建前的准备" class="headerlink" title="构建前的准备"></a>构建前的准备</h3><p>准备同 html5 接近，因为需要连接外部服务，而且因为 uwsig 服务默认不支持静态文件的处理，所以多了一些对原代码的改造。</p>
<h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p>首先是 django 应用的目录，比如有一个应用叫 taikang，目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">taikang	# 项目根目录	</span><br><span class="line">├── Dockerfile	# Dockerfile 文件</span><br><span class="line">├── logs	</span><br><span class="line">├── manage.py</span><br><span class="line">├── Makefile	# makefile 文件</span><br><span class="line">├── requirements.txt	# 应用依赖的 python 库</span><br><span class="line">├── templates</span><br><span class="line">└── taikang		# 应用目录</span><br><span class="line">	├── __init__.py</span><br><span class="line">	├── models.py</span><br><span class="line">	├── settings.py   # django 的配置文件</span><br><span class="line">	├── urls.py</span><br><span class="line">	├── views.py</span><br><span class="line">	└── wsgi.py</span><br></pre></td></tr></table></figure>
<p>Dockerfile 文件编写<br>Dockerfile 文件的含义和 html5 部署中是完全相同的，这里为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 python2.7.10 版本作为基础服务</span></span><br><span class="line"><span class="keyword">from</span> python:<span class="number">2.7</span><span class="number">.10</span></span><br><span class="line">将当前项目中的内容全 copy 到镜像中的 /src 目录下</span><br><span class="line">COPY . /src</span><br><span class="line"><span class="comment"># 安装 django 应用依赖的库，这里设置为豆瓣的 pypi 源</span></span><br><span class="line">RUN cd /src; pip install -r  requirements.txt -i http://pypi.douban.com/simple --trusted-host pypi.douban.com</span><br><span class="line"><span class="comment"># 镜像暴露出 8000 端口</span></span><br><span class="line">EXPOSE <span class="number">8000</span></span><br><span class="line"><span class="comment"># 设置工作目录为代码所在目录</span></span><br><span class="line">WORKDIR  /src</span><br><span class="line"><span class="comment"># 设置应用启动命令</span></span><br><span class="line">CMD [<span class="string">&quot;make&quot;</span>, <span class="string">&quot;start-uwsgi&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Makefile-文件编写"><a href="#Makefile-文件编写" class="headerlink" title="Makefile 文件编写"></a>Makefile 文件编写</h4><p>可以注意到，上述最后的启动命令中使用了 make 命令，这也是前面目录结构中 Makefile 文件的作用所在。有关 makefile 的知识，这里不再详述。<br>总之可以让你更方便的管理应用，这里直接贴出 makefile 文件：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uwsig 启动的 host 和端口 </span></span><br><span class="line">host:=0.0.0.0</span><br><span class="line">port:=8000</span><br><span class="line"><span class="comment"># debug 的时候直接使用 django 自带的服务启动</span></span><br><span class="line"><span class="section">debug:</span></span><br><span class="line">    ./manage.py runserver <span class="variable">$(host)</span>:<span class="variable">$(port)</span></span><br><span class="line"><span class="comment"># 启动 uwsgi 服务</span></span><br><span class="line"><span class="section">start-uwsgi:</span></span><br><span class="line">    uwsgi --socket <span class="variable">$(host)</span>:<span class="variable">$(port)</span> \</span><br><span class="line">        --chdir <span class="variable">$(<span class="built_in">shell</span> pwd)</span> \</span><br><span class="line">        --wsgi-file taikang/wsgi.py \</span><br><span class="line">        --master \</span><br><span class="line">        --process 4 \</span><br><span class="line">        --pidfile <span class="variable">$(<span class="built_in">shell</span> pwd)</span>/uwsgi.pid</span><br><span class="line"><span class="comment"># 停止 uwsgi 服务</span></span><br><span class="line"><span class="section">stop-uwsgi:</span></span><br><span class="line">    uwsgi --stop uwsgi.pid</span><br><span class="line"><span class="comment"># 重载 uwsgi 服务</span></span><br><span class="line"><span class="section">reload-uwsgi:</span></span><br><span class="line">    uwsgi --reload uwsgi.pid</span><br><span class="line"><span class="comment"># 收集静态文件</span></span><br><span class="line"><span class="section">collectstatic:</span></span><br><span class="line">    ./manage.py collectstatic --noinput</span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: debug \</span></span><br><span class="line">    collectstatic \</span><br><span class="line">    reload-uwsgi \</span><br><span class="line">    start-uwsgi \</span><br><span class="line">    stop-uwsgi</span><br></pre></td></tr></table></figure>
<h4 id="静态文件支持"><a href="#静态文件支持" class="headerlink" title="静态文件支持"></a>静态文件支持</h4><p>在 uwsgi 提供服务时，静态文件需要单独进行处理，目前推荐使用 django 的 whitenoise 库。可以方便的提供静态文件服务，仅仅需要几行配置。</p>
<h4 id="通过环境变量来连接服务"><a href="#通过环境变量来连接服务" class="headerlink" title="通过环境变量来连接服务"></a>通过环境变量来连接服务</h4><p>在使用 docker 部署项目，当需要连接外部的服务时，一般通过 link + 环境变量的参数进行。而为了支持环境变量的形式，我们的 django 应用也要做一些相应的改变。具体就是修改 settings.py 中的配置。</p>
<p>修改 settings.py 文件，以 mysql 为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原来的 mysql 配置文件</span></span><br><span class="line"><span class="comment">#DATABASES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;default&#x27;: &#123;</span></span><br><span class="line"><span class="comment">#        &#x27;ENGINE&#x27;: &#x27;django.db.backends.mysql&#x27;,</span></span><br><span class="line"><span class="comment">#        &#x27;NAME&#x27;: &#x27;starding_taikang&#x27;,</span></span><br><span class="line"><span class="comment">#        &#x27;USER&#x27;: &#x27;root&#x27;,</span></span><br><span class="line"><span class="comment">#        &#x27;PASSWORD&#x27;: &#x27;your_password_here&#x27;,</span></span><br><span class="line"><span class="comment">#        &#x27;HOST&#x27;: &#x27;localhost&#x27;,</span></span><br><span class="line"><span class="comment">#        &#x27;PORT&#x27;: &#x27;3306&#x27;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># 通过获取环境变量的形式来获取服务</span></span><br><span class="line"><span class="keyword">import</span> os  <span class="comment"># 导入 os 库</span></span><br><span class="line">mysql_name = os.environ.get(<span class="string">&#x27;MYSQL_INSTANCE_NAME&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;taikang&quot;</span>  <span class="comment"># 获取数据库名称</span></span><br><span class="line">mysql_user = os.environ.get(<span class="string">&#x27;MYSQL_USERNAME&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;root&quot;</span>  <span class="comment"># 获取 mysql 用户名</span></span><br><span class="line">mysql_password = os.environ.get(<span class="string">&#x27;MYSQL_PASSWORD&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;your_password&quot;</span>  <span class="comment"># 获取密码</span></span><br><span class="line">mysql_host = os.environ.get(<span class="string">&#x27;MYSQL_ADDR&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;127.0.0.1&quot;</span>  <span class="comment"># 获取服务地址</span></span><br><span class="line">mysql_port = <span class="string">&quot;3306&quot;</span></span><br><span class="line"><span class="comment"># 直接使用上面的变量代替字符串</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">   <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">       <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;NAME&#x27;</span>: mysql_name,</span><br><span class="line">       <span class="string">&#x27;USER&#x27;</span>: mysql_user,</span><br><span class="line">       <span class="string">&#x27;PASSWORD&#x27;</span>: mysql_password,</span><br><span class="line">       <span class="string">&#x27;HOST&#x27;</span>: mysql_host,</span><br><span class="line">       <span class="string">&#x27;PORT&#x27;</span>: mysql_port</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-daocloud-部署构建好的-taikang-项目"><a href="#使用-daocloud-部署构建好的-taikang-项目" class="headerlink" title="使用 daocloud 部署构建好的 taikang 项目"></a>使用 daocloud 部署构建好的 taikang 项目</h3><p>步骤基本同 html5 部署，假设你完成镜像构建之后，产生的镜像地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daocloud.io/xiaohuruwei/taking:latest</span><br></pre></td></tr></table></figure>
<p>下一步在使用镜像部署的时候，需要连接外部服务，具体是手动编辑 yaml 文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">takang_test:</span><br><span class="line">  image: daocloud.io/xiaohuruwei/taking:latest</span><br><span class="line">  restart: always</span><br><span class="line">  external_links:</span><br><span class="line">  - mysql1:mysql	  <span class="comment"># 前面的 mysql1 是你主机上已经存在的 mysql 的容器实例，冒号后面是别名</span></span><br><span class="line">  ports:</span><br><span class="line">  - <span class="string">&#x27;8000&#x27;</span></span><br><span class="line">  environment:    <span class="comment"># 环境变量    </span></span><br><span class="line">  - MYSQL_ADDR=mysql</span><br></pre></td></tr></table></figure>

<p>但是我发现这种方法似乎有一些 bug，如果上面的方法不成功，那么你就先直接部署，部署成功之后，再去修改 yaml 文件成为上面描述的样子。在修改 yaml 文件的时候，daocloud 会提示重新部署，选择确定即可。</p>
<p>至此，django 项目也部署完成了。然后同 html5 项目部署一样，把各种自动构建，自动发布的功能打开就行了。</p>
<p>注意：由于 django 项目是使用 uwsgi 部署的，直接访问 daocloud 给出的地址是错误的，这个时候必须配置 nginx 反向代理。</p>
<p>附上 uwsgi 部署的 django nginx 代理配置文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xiaohuruwei.com;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/taikang.access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/taikang.<span class="literal">error</span>.log;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">200m</span>;</span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">    <span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">64k</span>;</span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/x-javascript text/javascript text/css application/xml;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">include</span> uwsgi_params;</span><br><span class="line">        <span class="attribute">uwsgi_pass</span> <span class="number">127.0.0.1:32801</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>2016.01 于北京回龙观</p>
  
	</div>
		<footer class="article-footer clearfix">
  <div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E4%BD%9C%E4%B8%BA%E5%B7%A5%E7%A8%8B%E5%B8%88/">作为工程师</a>
</div>


</div>

 
  <div class="article-share" id="share">
    <div
      data-url="http://starding.github.io/2016/01/07/daocloud-deploy/"
      data-title="使用 daocloud 持续集成应用 | 结绳以渔"
      data-tsina=""
      class="share clearfix"
    ></div>
  </div>
   
</footer>
   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/01/07/deploy-gitlab-by-docker/" title="docker 部署 gitlab">
  <strong>上一篇：</strong><br/>
  <span>
  docker 部署 gitlab</span>
</a>
</div>


<div class="next">
<a href="/2016/01/07/docker-a-metaphor/"  title="Docker——从隐喻说起">
 <strong>下一篇：</strong><br/> 
 <span>Docker——从隐喻说起
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E8%AF%9D"><span class="toc-number">1.</span> <span class="toc-text">写在前面的话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#daocloud-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">daocloud 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%AE%80%E5%8D%95%E7%9A%84-html5-%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">持续集成简单的 html5 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%B0%8F%E8%8A%82%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.1.</span> <span class="toc-text">本小节使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E3%80%8C%E7%AE%80%E5%8D%95%E7%9A%84-html5-%E5%BA%94%E7%94%A8%E3%80%8D"><span class="toc-number">3.2.</span> <span class="toc-text">什么是「简单的 html5 应用」</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%A4%A7%E8%87%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.3.</span> <span class="toc-text">部署大致解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">3.4.</span> <span class="toc-text">构建应用前的准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.4.1.</span> <span class="toc-text">应用目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Dockerfile-%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">创建 Dockerfile 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9C%A8-docker-%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82"><span class="toc-number">3.4.3.</span> <span class="toc-text">配置在 docker 中使用的 nginx 配置文件。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-daocloud-%E8%BF%9B%E8%A1%8C%E6%8C%81%E7%BB%AD%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%BB%A5%E5%8F%8A%E5%8F%91%E5%B8%83"><span class="toc-number">3.5.</span> <span class="toc-text">使用 daocloud 进行持续构建镜像以及发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.6.</span> <span class="toc-text">发布完成之后需要做的工作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BE%9D%E8%B5%96%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">持续集成依赖外部服务的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E9%80%82%E7%94%A8%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">4.1.</span> <span class="toc-text">本文适用的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">依赖外部服务的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">4.3.</span> <span class="toc-text">构建前的准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Makefile-%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="toc-number">4.3.2.</span> <span class="toc-text">Makefile 文件编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81"><span class="toc-number">4.3.3.</span> <span class="toc-text">静态文件支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%9D%A5%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.4.</span> <span class="toc-text">通过环境变量来连接服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-daocloud-%E9%83%A8%E7%BD%B2%E6%9E%84%E5%BB%BA%E5%A5%BD%E7%9A%84-taikang-%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.4.</span> <span class="toc-text">使用 daocloud 部署构建好的 taikang 项目</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/作为工程师/" title="作为工程师">作为工程师<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/科哲和科学史/" title="科哲和科学史">科哲和科学史<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://finaltheory.me/" target="_blank" title=" 18~26 岁期间对我影响很大的同学">黄龑</a>
            
          </li>
        
          <li>
            
            	<a href="https://chuan.us" target="_blank" title=" 虽然不认识，但 30 岁之后我从他的言论中学到了很多">硅谷王川</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
  
  <div class="line">
    <span></span>
    <div class="author"></div>
  </div>
   
  <section class="info">
    <p>
      人存于世，因缘际会 <br />
      我是兴华，很高兴见到你
    </p>
  </section>
  
  <div class="social-font" class="clearfix">
     
    <a
      href="https://github.com/starding"
      target="_blank"
      class="icon-github"
      title="github"
    ></a>
      
    <a
      href="https://twitter.com/starstarding"
      target="_blank"
      class="icon-twitter"
      title="twitter"
    ></a>
          
    <a
      href="mailto:starstarding@gmail.com"
      target="_blank"
      class="icon-email"
      title="Email Me"
    ></a>
    
  </div>
   

  <p class="copyright">
    Powered by
    <a href="http://hexo.io" target="_blank" title="hexo">Hexo</a>
	
    © 2016~2024 
    <a
      href="/about"
      target="_blank"
      title="XingHua"
      >XingHua</a
    >
    
  </p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
  $(document).ready(function(){
    $('.navbar').click(function(){
      $('header nav').toggleClass('shownav');
    });
    var myWidth = 0;
    function getSize(){
      if( typeof( window.innerWidth ) == 'number' ) {
        myWidth = window.innerWidth;
      } else if( document.documentElement && document.documentElement.clientWidth) {
        myWidth = document.documentElement.clientWidth;
      };
    };
    var m = $('#main'),
        a = $('#asidepart'),
        c = $('.closeaside'),
        o = $('.openaside');
    c.click(function(){
      a.addClass('fadeOut').css('display', 'none');
      o.css('display', 'block').addClass('fadeIn');
      m.addClass('moveMain');
    });
    o.click(function(){
      o.css('display', 'none').removeClass('beforeFadeIn');
      a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
      m.removeClass('moveMain');
    });
    $(window).scroll(function(){
      o.css("top",Math.max(80,260-$(this).scrollTop()));
    });
    
    $(window).resize(function(){
      getSize();
      if (myWidth >= 1024) {
        $('header nav').removeClass('shownav');
      }else{
        m.removeClass('moveMain');
        a.css('display', 'block').removeClass('fadeOut');
        o.css('display', 'none');
        
        $('#toc.toc-aside').css('display', 'none');
        
      }
    });
  });
</script>

<script type="text/javascript">
  $(document).ready(function () {
    var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t = $('#toc'),
      ta = $('#toc.toc-aside'),
      o = $('.openaside'),
      c = $('.closeaside')
    if (ai.length > 0) {
      ai.wrap('<div class="video-container" />')
    }
    if (ae.length > 0) {
      ae.wrap('<div class="video-container" />')
    }
    c.click(function () {
      ta.css('display', 'block').addClass('fadeIn')
    })
    o.click(function () {
      ta.css('display', 'none')
    })
    $(window).scroll(function () {
      ta.css('top', Math.max(140, 320 - $(this).scrollTop()))
    })
  })
</script>
 
<script type="text/javascript">
  $(document).ready(function () {
    var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description')
    var html = [
      '<div class="hoverqrcode clearfix"></div>',
      '<a class="overlay" id="qrcode"></a>',
      '<a href="https://twitter.com/intent/tweet?url=' +
        encodedUrl +
        '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
      '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
      '<span title="Share to"></span>',
    ].join('')
    $this.append(html)

    $('.hoverqrcode').hide()

    var myWidth = 0
    function updatehoverqrcode() {
      if (typeof window.innerWidth == 'number') {
        myWidth = window.innerWidth
      } else if (
        document.documentElement &&
        document.documentElement.clientWidth
      ) {
        myWidth = document.documentElement.clientWidth
      }
      var qrsize = myWidth > 1024 ? 200 : 100
      var options = {
        render: 'image',
        size: qrsize,
        fill: '#2ca6cb',
        text: url,
        radius: 0.5,
        quiet: 1,
      }
      var p = $('.article-share-qrcode').position()
      $('.hoverqrcode')
        .empty()
        .css('width', qrsize)
        .css('height', qrsize)
        .css('left', p.left - qrsize / 2 + 20)
        .css('top', p.top - qrsize - 10)
        .qrcode(options)
    }
    $(window).resize(function () {
      $('.hoverqrcode').hide()
    })
    $('.article-share-qrcode').click(function () {
      updatehoverqrcode()
      $('.hoverqrcode').toggle()
    })
    $('.article-share-qrcode').hover(
      function () {},
      function () {
        $('.hoverqrcode').hide()
      }
    )
  })
</script>
  
<script type="text/javascript">
  
  var disqus_shortname = 'xinghuading';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>
    
<link
  rel="stylesheet"
  href="/fancybox/jquery.fancybox.css"
  media="screen"
  type="text/css"
/>
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    $('.article-content').each(function (i) {
      $(this)
        .find('img')
        .each(function () {
          if ($(this).parent().hasClass('fancybox')) return
          var alt = this.alt
          if (alt) $(this).after('<span class="caption">' + alt + '</span>')
          $(this).wrap(
            '<a href="' +
              this.src +
              '" title="' +
              alt +
              '" class="fancybox"></a>'
          )
        })
      $(this)
        .find('.fancybox')
        .each(function () {
          $(this).attr('rel', 'article' + i)
        })
    })
    if ($.fancybox) {
      $('.fancybox').fancybox()
    }
  })
</script>


<!-- Analytics Begin -->

 <!-- Google tag (gtag.js) -->
    <script async
        src="https://www.googletagmanager.com/gtag/js?id=G-K5Z9WLE5XK">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config',
        'G-K5Z9WLE5XK');
    </script>


    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src =
                "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
